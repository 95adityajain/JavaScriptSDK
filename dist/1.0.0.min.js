function greatCircleFormula(a,b){var c=(a.document.coordinates[1]-b.document.coordinates[1]).toRad(),d=(a.document.coordinates[0]-b.document.coordinates[0]).toRad(),e=b.document.coordinates[1].toRad(),f=a.document.coordinates[1].toRad(),g=Math.sin(c/2)*Math.sin(c/2)+Math.sin(d/2)*Math.sin(d/2)*Math.cos(e)*Math.cos(f),h=2*Math.atan2(Math.sqrt(g),Math.sqrt(1-g));return h}function _all(a){return jQuery.when.apply(jQuery,a).then(function(){return Array.prototype.slice.call(arguments,0)})}var CB=CB||{};CB.version="1.0.0",CB._isNode=!1,CB.Socket=null,CB.serverUrl="https://api.cloudboost.io",CB.socketIoUrl="http://realtime.cloudboost.io",CB.io=null,CB.apiUrl=CB.serverUrl+"/api",CB.appId=CB.appId||null,CB.appKey=CB.appKey||null,"undefined"!=typeof process&&process.versions&&process.versions.node?CB._isNode=!0:CB._isNode=!1,CB._ajaxIE8=function(a,b,c){var d=new CB.Promise,e=new XDomainRequest;return e.onload=function(){var a;try{a=JSON.parse(e.responseText)}catch(b){d.reject(b)}a&&d.resolve(a)},e.onerror=e.ontimeout=function(){var a={responseText:JSON.stringify({code:500,error:"IE's XDomainRequest does not supply error info."})};d.reject(a)},e.onprogress=function(){},e.open(a,b),e.send(c),d},CB._loadXml=function(){var a,b="function"==typeof require?require:null;return"undefined"!=typeof XMLHttpRequest?a=XMLHttpRequest:"function"==typeof require&&"undefined"==typeof require.ensure&&(a=b("xmlhttprequest").XMLHttpRequest),a=new a},CB.Promise=function(){this._resolved=!1,this._rejected=!1,this._resolvedCallbacks=[],this._rejectedCallbacks=[],this._isPromisesAPlusCompliant=!1,this.is=function(a){return a&&a.then&&"[object Function]"===Object.prototype.toString.call(a.then)},this.as=function(){var a=new CB.Promise;return a.resolve.apply(a,arguments),a},this.error=function(){var a=new CB.Promise;return a.reject.apply(a,arguments),a},this.when=function(a){var b;b=!a||"undefined"!=typeof a.length&&null!==a.length?a:arguments;var c=b.length,d=!1,e=[],f=[];if(e.length=b.length,f.length=b.length,0===c)return CB.Promise.as.apply(this,e);var g=new CB.Promise,h=function(){c-=1,0===c&&(d?g.reject(f):g.resolve.apply(g,e))};return b.forEach(function(a,b){CB.Promise.is(a)?a.then(function(a){e[b]=a,h()},function(a){f[b]=a,d=!0,h()}):(e[b]=a,h())}),g},this._continueWhile=function(a,b){return a()?b().then(function(){return CB.Promise._continueWhile(a,b)}):CB.Promise.as()}},CB.Promise.is=function(a){return a&&a.then&&"[object Function]"===Object.prototype.toString.call(a.then)},CB.Promise.prototype.resolve=function(a){if(this._resolved||this._rejected)throw"A promise was resolved even though it had already been "+(this._resolved?"resolved":"rejected")+".";this._resolved=!0,this._result=arguments;var b=arguments;this._resolvedCallbacks.forEach(function(a){a.apply(this,b)}),this._resolvedCallbacks=[],this._rejectedCallbacks=[]},CB.Promise.prototype.reject=function(a){if(this._resolved||this._rejected)throw"A promise was rejected even though it had already been "+(this._resolved?"resolved":"rejected")+".";this._rejected=!0,this._error=a,this._rejectedCallbacks.forEach(function(b){b(a)}),this._resolvedCallbacks=[],this._rejectedCallbacks=[]},CB.Promise.prototype.then=function(a,b){var c=new CB.Promise,d=function(){var b=arguments;if(a)if(CB.Promise._isPromisesAPlusCompliant)try{b=[a.apply(this,b)]}catch(d){b=[CB.Promise.error(d)]}else b=[a.apply(this,b)];1===b.length&&CB.Promise.is(b[0])?b[0].then(function(){c.resolve.apply(c,arguments)},function(a){c.reject(a)}):c.resolve.apply(c,b)},e=function(a){var d=[];if(b){if(CB.Promise._isPromisesAPlusCompliant)try{d=[b(a)]}catch(e){d=[CB.Promise.error(e)]}else d=[b(a)];1===d.length&&CB.Promise.is(d[0])?d[0].then(function(){c.resolve.apply(c,arguments)},function(a){c.reject(a)}):CB.Promise._isPromisesAPlusCompliant?c.resolve.apply(c,d):c.reject(d[0])}else c.reject(a)},f=function(a){a.call()};CB.Promise._isPromisesAPlusCompliant&&("undefined"!=typeof window&&window.setTimeout?f=function(a){window.setTimeout(a,0)}:"undefined"!=typeof process&&process.nextTick&&(f=function(a){process.nextTick(a)}));var g=this;return this._resolved?f(function(){d.apply(g,g._result)}):this._rejected?f(function(){e(g._error)}):(this._resolvedCallbacks.push(d),this._rejectedCallbacks.push(e)),c},CB.Promise.prototype.always=function(a){return this.then(a,a)},CB.Promise.prototype.done=function(a){return this.then(a)},CB.Promise.prototype.fail=function(a){return this.then(null,a)},CB.clone=function(a){return"[object Object]"===!Object.prototype.toString.call(a)?a:"[object Array]"===Object.prototype.toString.call(a)?a.slice():new Object(a)},CB.Promise.prototype._thenRunCallbacks=function(a,b){var c;if("[object Function]"===Object.prototype.toString.call(a)){var d=a;c={success:function(a){d(a,null)},error:function(a){d(null,a)}}}else c=CB.clone(a);return c=c||{},this.then(function(a){return c.success?c.success.apply(this,arguments):b&&b.trigger("sync",b,a,c),CB.Promise.as.apply(CB.Promise,arguments)},function(a){return c.error?c.error(a):b&&b.trigger("error",b,a,c),CB.Promise.error(a)})},CB.Events={trigger:function(a){var b,c,d,e,f,g,h;if(!(d=this._callbacks))return this;for(g=d.all,a=a.split(eventSplitter),h=slice.call(arguments,1),b=a.shift();b;){if(c=d[b])for(e=c.tail;(c=c.next)!==e;)c.callback.apply(c.context||this,h);if(c=g)for(e=c.tail,f=[b].concat(h);(c=c.next)!==e;)c.callback.apply(c.context||this,f);b=a.shift()}return this}},CB.Promise.prototype._continueWith=function(a){return this.then(function(){return a(arguments,null)},function(b){return a(null,b)})},console.log("promises loaded"),console.log(CB),console.log("in acl"),CB.ACL=function(){this.read={allow:{user:["all"],role:[]},deny:{user:[],role:[]}},this.write={allow:{user:["all"],role:[]},deny:{user:[],role:[]}}},CB.ACL.prototype.setPublicWriteAccess=function(a){if(a)this.write.allow.user=["all"];else{var b=this.write.allow.user.indexOf("all");b>-1&&this.write.allow.user.splice(b,1)}},CB.ACL.prototype.setPublicReadAccess=function(a){if(a)this.read.allow.user=["all"];else{var b=this.read.allow.user.indexOf("all");b>-1&&this.read.allow.user.splice(b,1)}},CB.ACL.prototype.setUserWriteAccess=function(a,b){if(b){var c=this.write.allow.user.indexOf("all");c>-1&&this.write.allow.user.splice(c,1),-1===this.write.allow.user.indexOf(a)&&this.write.allow.user.push(a)}else{var c=this.write.allow.user.indexOf(a);c>-1&&this.write.allow.user.splice(c,1),this.write.deny.user.push(a)}},CB.ACL.prototype.setUserReadAccess=function(a,b){if(b){var c=this.read.allow.user.indexOf("all");c>-1&&this.read.allow.user.splice(c,1),-1===this.read.allow.user.indexOf(a)&&this.read.allow.user.push(a)}else{var c=this.read.allow.user.indexOf(a);c>-1&&this.read.allow.user.splice(c,1),this.read.deny.user.push(a)}},CB.ACL.prototype.setRoleWriteAccess=function(a,b){if(b){var c=this.write.allow.user.indexOf("all");c>-1&&this.write.allow.user.splice(c,1),-1===this.write.allow.role.indexOf(a)&&this.write.allow.role.push(a)}else{var c=this.write.allow.role.indexOf(a);c>-1&&this.write.allow.role.splice(c,1);var c=this.write.allow.user.indexOf("all");c>-1&&this.write.allow.user.splice(c,1),this.write.deny.role.push(a)}},CB.ACL.prototype.setRoleReadAccess=function(a,b){if(b){var c=this.read.allow.user.indexOf("all");c>-1&&this.read.allow.user.splice(c,1),-1===this.read.allow.role.indexOf(a)&&this.read.allow.role.push(a)}else{var c=this.read.allow.role.indexOf(a);c>-1&&this.read.allow.role.splice(c,1);var c=this.read.allow.user.indexOf("all");c>-1&&this.read.allow.user.splice(c,1),this.read.deny.role.push(a)}},CB.CloudNotification=CB.CloudNotification||{},CB.CloudNotification.on=function(a,b,c){CB._validate();var d;return c||(d=new CB.Promise),CB.Socket.emit("join-custom-channel",CB.appId+a),CB.Socket.on(CB.appId+a,function(a){b(a)}),c&&c.success?c.success():d.resolve(),c?void 0:d},CB.CloudNotification.off=function(a,b){CB._validate();var c;return b||(c=new CB.Promise),CB.Socket.emit("leave-custom-channel",CB.appId+a),CB.Socket.removeAllListeners(CB.appId+a),b&&b.success?b.success():c.resolve(),b?void 0:c},CB.CloudNotification.publish=function(a,b,c){CB._validate();var d;return c||(d=new CB.Promise),CB.Socket.emit("publish-custom-channel",{channel:CB.appId+a,data:b}),c&&c.success?c.success():d.resolve(),c?void 0:d},CB.CloudObject=function(a){this.document={},this.document._tableName=a,this.document.ACL=new CB.ACL,this.document._type="custom",this.document._isModified=!0,this.document._modifiedColumns=["createdAt","updatedAt","ACL"]},Object.defineProperty(CB.CloudObject.prototype,"ACL",{get:function(){return this.document.ACL},set:function(a){this.document.ACL=a,CB._modified(this,"ACL")}}),Object.defineProperty(CB.CloudObject.prototype,"id",{get:function(){return this.document._id},set:function(a){this.document._id=a,CB._modified(this,"_id")}}),Object.defineProperty(CB.CloudObject.prototype,"createdAt",{get:function(){return this.document.createdAt},set:function(a){this.document.createdAt=a,CB._modified(this,"createdAt")}}),Object.defineProperty(CB.CloudObject.prototype,"updatedAt",{get:function(){return this.document.updatedAt},set:function(a){this.document.updatedAt=a,CB._modified(this,"updatedAt")}}),Object.defineProperty(CB.CloudObject.prototype,"isSearchable",{get:function(){return this.document._isSearchable},set:function(a){this.document._isSearchable=a,CB._modified(this,"_isSearchable")}}),Object.defineProperty(CB.CloudObject.prototype,"expires",{get:function(){return this.document._expires},set:function(a){this.document._expires=a,CB._modified(this,"_expires")}}),CB.CloudObject.on=function(a,b,c,d){var e;if(d||(e=new CB.Promise),a=a.toLowerCase(),b instanceof Array)for(var f=0;f<b.length;f++)CB.CloudObject.on(a,b[f],c),d&&d.success?d.success():e.resolve();else{if(b=b.toLowerCase(),"created"!==b&&"updated"!==b&&"deleted"!==b)throw"created, updated, deleted are supported notification types.";CB.Socket.emit("join-object-channel",(CB.appId+"table"+a+b).toLowerCase()),CB.Socket.on((CB.appId+"table"+a+b).toLowerCase(),function(a){c(CB._deserialize(a))}),d&&d.success?d.success():e.resolve()}return d?void 0:e},CB.CloudObject.off=function(a,b,c){var d;if(c||(d=new CB.Promise),a=a.toLowerCase(),b instanceof Array)for(var e=0;e<b.length;e++)CB.CloudObject.off(a,b[e]),c&&c.success?c.success():d.resolve();else{if(b=b.toLowerCase(),"created"!==b&&"updated"!==b&&"deleted"!==b)throw"created, updated, deleted are supported notification types.";CB.Socket.emit("leave-object-channel",(CB.appId+"table"+a+b).toLowerCase()),CB.Socket.removeAllListeners((CB.appId+"table"+a+b).toLowerCase()),c&&c.success?c.success():d.resolve()}return c?void 0:d},CB.CloudObject.prototype.set=function(a,b){var c=["_tableName","_type","operator"];if(("id"===a||"isSearchable"===a||"expires"===a)&&(a="_"+a),c.indexOf(a)>-1)throw a+" is a keyword. Please choose a different column name.";this.document[a]=b,CB._modified(this,a)},CB.CloudObject.prototype.get=function(a){return("id"===a||"isSearchable"===a||"expires"===a)&&(a="_"+a),CB._modified(this,a),this.document[a]},CB.CloudObject.prototype.unset=function(a){this.document[a]=null},CB.CloudObject.prototype.save=function(a){var b;a||(b=new CB.Promise),CB._validate();var c=this,d=(CB._loadXml(),JSON.stringify({document:CB._serialize(c),key:CB.appKey}));return url=CB.apiUrl+"/"+CB.appId+"/save",CB._request("POST",url,d).then(function(d){CB._deserialize(JSON.parse(d),c),a?a.success(c):b.resolve(c)},function(c){a?a.error(c):b.reject(c)}),a?void 0:b},CB.CloudObject.prototype.fetch=function(a){if(!CB.appId)throw"CB.appId is null.";if(!this.id)throw"Can't fetch an object which is not saved.";this.document._id=this.id,this.ACL&&(this.document.ACL=this.ACL),thisObj=this;var b;a||(b=new CB.Promise);var c=JSON.stringify({key:CB.appKey});return url=CB.apiUrl+"/"+CB.appId+"/"+thisObj.document._tableName+"/get/"+thisObj.document._id,CB._request("POST",url,c).then(function(c){CB._deserialize(JSON.parse(c),thisObj),a?a.success(thisObj):b.resolve(thisObj)},function(c){a?a.error(c):b.reject(c)}),a?void 0:b},CB.CloudObject.prototype["delete"]=function(a){if(!CB.appId)throw"CB.appId is null.";if(!this.document._id)throw"You cannot delete an object which is not saved.";var b,c=this;a||(b=new CB.Promise);var d=JSON.stringify({key:CB.appKey,document:CB._serialize(c)});return url=CB.apiUrl+"/"+CB.appId+"/delete/",CB._request("POST",url,d).then(function(d){a?a.success(c):b.resolve(c)},function(c){a?a.error(c):b.reject(c)}),a?void 0:b},CB.CloudQuery=function(a){this.tableName=a,this.query={},this.query.$include=[],this.select={},this.sort={},this.skip=0,this.limit=-1},CB.CloudQuery.or=function(a,b){if(!a.tableName===b.tableName)throw"Table names are not same";var c=new CB.CloudQuery(a.tableName);return c.query.$or=[a.query,b.query],c},CB.CloudQuery.prototype.equalTo=function(a,b){return("id"===a||"isSearchable"===a||"expires"===a)&&(a="_"+a),this.query[a]=b,this},CB.CloudQuery.prototype.include=function(a,b){return("id"===a||"isSearchable"===a||"expires"===a)&&(a="_"+a),this.query.$include.push(a),this},CB.CloudQuery.prototype.notEqualTo=function(a,b){return("id"===a||"isSearchable"===a||"expires"===a)&&(a="_"+a),this.query[a]={$ne:b},this},CB.CloudQuery.prototype.greaterThan=function(a,b){return("id"===a||"isSearchable"===a||"expires"===a)&&(a="_"+a),this.query[a]||(this.query[a]={}),this.query[a].$gt=b,this},CB.CloudQuery.prototype.greaterThanEqualTo=function(a,b){return("id"===a||"isSearchable"===a||"expires"===a)&&(a="_"+a),this.query[a]||(this.query[a]={}),this.query[a].$gte=b,this},CB.CloudQuery.prototype.lessThan=function(a,b){return("id"===a||"isSearchable"===a||"expires"===a)&&(a="_"+a),this.query[a]||(this.query[a]={}),this.query[a].$lt=b,this},CB.CloudQuery.prototype.lessThanEqualTo=function(a,b){return("id"===a||"isSearchable"===a||"expires"===a)&&(a="_"+a),this.query[a]||(this.query[a]={}),this.query[a].$lte=b,this},CB.CloudQuery.prototype.orderByAsc=function(a){return("id"===a||"isSearchable"===a||"expires"===a)&&(a="_"+a),this.sort[a]=1,this},CB.CloudQuery.prototype.orderByDesc=function(a){return("id"===a||"isSearchable"===a||"expires"===a)&&(a="_"+a),this.sort[a]=-1,this},CB.CloudQuery.prototype.setLimit=function(a){return this.limit=a,this},CB.CloudQuery.prototype.setSkip=function(a){return this.skip=a,this},CB.CloudQuery.prototype.selectColumn=function(a){if("[object Object]"===Object.prototype.toString.call(a))this.select=a;else if("[object Array]"===Object.prototype.toString.call(a))for(var b=0;b<a.length;b++)this.select[a[b]]=1;else this.select[a]=1;return this},CB.CloudQuery.prototype.doNotSelectColumn=function(a){if("[object Object]"===Object.prototype.toString.call(a))this.select=a;else if("[object Array]"===Object.prototype.toString.call(a))for(var b=0;b<a.length;b++)this.select[a[b]]=0;else this.select[a]=0;return this},CB.CloudQuery.prototype.containedIn=function(a,b){if(("id"===a||"isSearchable"===a||"expires"===a)&&(a="_"+a),"[object Object]"===Object.prototype.toString.call(b))throw"Array or string expected as an argument";return this.query[a]||(this.query[a]={}),"[object Array]"===Object.prototype.toString.call(b)?(this.query[a].$in=b,thisObj=this,"undefined"!=typeof this.query[a].$nin&&b.forEach(function(b){(index=thisObj.query[a].$nin.indexOf(b))>=0&&thisObj.query[a].$nin.splice(index,1)})):(this.query[a].$in||(this.query[a].$in=[]),-1===this.query[a].$in.indexOf(b)&&this.query[a].$in.push(b),"undefined"!=typeof this.query[a].$nin&&(index=this.query[a].$nin.indexOf(b))>=0&&this.query[a].$nin.splice(index,1)),this},CB.CloudQuery.prototype.notContainedIn=function(a,b){if(("id"===a||"isSearchable"===a||"expires"===a)&&(a="_"+a),"[object Object]"===Object.prototype.toString.call(b))throw"Array or string expected as an argument";return this.query[a]||(this.query[a]={}),"[object Array]"===Object.prototype.toString.call(b)?(this.query[a].$nin=b,"undefined"!=typeof this.query[a].$in&&(thisObj=this,b.forEach(function(b){(index=thisObj.query[a].$in.indexOf(b))>=0&&thisObj.query[a].$in.splice(index,1)}))):(this.query[a].$nin||(this.query[a].$nin=[]),-1===this.query[a].$nin.indexOf(b)&&this.query[a].$nin.push(b),"undefined"!=typeof this.query[a].$in&&(index=this.query[a].$in.indexOf(b))>=0&&this.query[a].$in.splice(index,1)),this},CB.CloudQuery.prototype.exists=function(a){return("id"===a||"isSearchable"===a||"expires"===a)&&(a="_"+a),this.query[a]||(this.query[a]={}),this.query[a].$exists=!0,this},CB.CloudQuery.prototype.doesNotExists=function(a){return("id"===a||"isSearchable"===a||"expires"===a)&&(a="_"+a),this.query[a]||(this.query[a]={}),this.query[a].$exists=!1,this},CB.CloudQuery.prototype.containsAll=function(a,b){return("id"===a||"isSearchable"===a||"expires"===a)&&(a="_"+a),this.query[a]?this.query[a].$all=b:this.query[a]={$all:b},this},CB.CloudQuery.prototype.startsWith=function(a,b){("id"===a||"isSearchable"===a||"expires"===a)&&(a="_"+a);var c="^"+b;return this.query[a]?(this.query[a].$regex=c,this.query[a].$options="im"):this.query[a]={$regex:c,$options:"im"},this},CB.CloudQuery.prototype.near=function(a,b,c,d){this.query[a]||(this.query[a]={},this.query[a].$near={$geometry:b.document,$maxDistance:c,$minDistance:d})},CB.CloudQuery.prototype.geoWithin=function(a,b,c){if(c)this.query[a]||(this.query[a]={},this.query[a].$geoWithin={$centerSphere:[b.document.coordinates,c/3963.2]});else{var d=[];if("[object Array]"!==Object.prototype.toString.call(b))throw"Invalid Parameter, coordinates should be an array of CloudGeoPoint Object";for(i=0;i<b.length;i++)b[i].document.hasOwnProperty("coordinates")&&(d[i]=b[i].document.coordinates);d[d.length]=d[0];var e="Polygon";this.query[a]||(this.query[a]={},this.query[a].$geoWithin={},this.query[a].$geoWithin.$geometry={type:e,coordinates:[d]})}},CB.CloudQuery.prototype.count=function(a){if(!CB.appId)throw"CB.appId is null.";if(!this.tableName)throw"TableName is null.";var b;a||(b=new CB.Promise);var c=this,d=JSON.stringify({query:c.query,limit:c.limit,skip:c.skip,key:CB.appKey});return url=CB.apiUrl+"/"+CB.appId+"/"+c.tableName+"/count",CB._request("POST",url,d).then(function(c){a?a.success(c):b.resolve(c)},function(c){a?a.error(c):b.reject(c)}),a?void 0:b},CB.CloudQuery.prototype.distinct=function(a,b){if(!CB.appId)throw"CB.appId is null.";if(!this.tableName)throw"TableName is null.";if("[object Array]"!==Object.prototype.toString.call(a)&&a.length<=0)throw"keys should be array";var c;b||(c=new CB.Promise);var d=this,e=JSON.stringify({onKey:a,query:d.query,sort:this.sort,key:CB.appKey});return url=CB.apiUrl+"/"+CB.appId+"/"+d.tableName+"/distinct",CB._request("POST",url,e).then(function(a){var d=CB._deserialize(JSON.parse(a));b?b.success(d):c.resolve(d)},function(a){b?b.error(a):c.reject(a)}),b?void 0:c},CB.CloudQuery.prototype.find=function(a){if(!CB.appId)throw"CB.appId is null.";if(!this.tableName)throw"TableName is null.";var b;a||(b=new CB.Promise);var c=this,d=(CB._loadXml(),JSON.stringify({query:c.query,select:c.select,sort:c.sort,limit:c.limit,skip:c.skip,key:CB.appKey}));return url=CB.apiUrl+"/"+CB.appId+"/"+c.tableName+"/find",CB._request("POST",url,d).then(function(c){var d=CB._deserialize(JSON.parse(c));a?a.success(d):b.resolve(d)},function(c){a?a.error(c):b.reject(c)}),a?void 0:b},CB.CloudQuery.prototype.get=function(a,b){var c=new CB.CloudQuery(this.tableName);return c.findById(a,b)},CB.CloudQuery.prototype.findById=function(a,b){if(!CB.appId)throw"CB.appId is null.";if(!this.tableName)throw"TableName is null.";var c;b||(c=new CB.Promise);var d=JSON.stringify({key:CB.appKey});return url=CB.apiUrl+"/"+CB.appId+"/"+this.tableName+"/get/"+a,CB._request("POST",url,d).then(function(a){"[object Array]"===Object.prototype.toString.call(a)&&(a=a[0]),b?b.success(CB._deserialize(JSON.parse(a))):c.resolve(CB._deserialize(JSON.parse(a)))},function(a){b?b.error(a):c.reject(a)}),b?void 0:c},CB.CloudQuery.prototype.findOne=function(a){if(!CB.appId)throw"CB.appId is null.";if(!this.tableName)throw"TableName is null.";var b;a||(b=new CB.Promise);var c=JSON.stringify({query:this.query,select:this.select,sort:this.sort,skip:this.skip,key:CB.appKey});return url=CB.apiUrl+"/"+CB.appId+"/"+this.tableName+"/findOne",CB._request("POST",url,c).then(function(c){var d=CB._deserialize(JSON.parse(c));a?a.success(d):b.resolve(d)},function(c){a?a.error(c):b.reject(c)}),a?void 0:b},CB.CloudSearch=function(a){this.collectionNames=a,this.query={},this.from=0,this.size=10,this.sort=[]},CB.CloudSearch.prototype.setSkip=function(a){return this.from=a,this},CB.CloudSearch.prototype.setLimit=function(a){return this.size=a,this},CB.CloudSearch.prototype.orderByAsc=function(a){("id"===a||"isSearchable"===a||"expires"===a)&&(a="_"+a);var b={};return b[a]={},b[a].order="asc",this.sort.push(b),this},CB.CloudSearch.prototype.orderByDesc=function(a){("id"===a||"isSearchable"===a||"expires"===a)&&(a="_"+a);var b={};return b[a]={},b[a].order="desc",this.sort.push(b),this},CB.CloudSearch.prototype._makeFilteredQuery=function(){if(this.query||(this.query={}),!this.query.filtered){var a=this.query;this.query={},this.query.filtered={},this.query.filtered.query=a,this.query.filtered.filter={}}this._isFilteredQuery=!0},CB.CloudSearch.prototype._getFilterItem=function(){for(var a in this.query.filtered.filter)return this.query.filtered.filter;return null},CB.CloudSearch.prototype._deleteFilterItems=function(){this.query.filtered.filter={}},CB.CloudSearch.prototype._createBoolFilter=function(){this.query.filtered.filter.bool||(this.query.filtered.filter.bool={}),this.query.filtered.filter.bool.must||(this.query.filtered.filter.bool.must=[]),this.query.filtered.filter.bool.should||(this.query.filtered.filter.bool.should=[]),this.query.filtered.filter.bool.must_not||(this.query.filtered.filter.bool.must_not=[])},CB.CloudSearch.prototype._createBoolQuery=function(){this.query.filtered?(this.query.filtered.query.bool||(this.query.filtered.query.bool={}),this.query.filtered.query.bool.must||(this.query.filtered.query.bool.must=[]),this.query.filtered.query.bool.must_not||(this.query.filtered.query.bool.must_not=[]),this.query.filtered.query.bool.should||(this.query.filtered.query.bool.should=[])):(this.query.bool||(this.query.bool={}),this.query.bool.must||(this.query.bool.must=[]),this.query.bool.must_not||(this.query.bool.must_not=[]),this.query.bool.should||(this.query.bool.should=[]))},CB.CloudSearch.prototype._appendPrevFilterToBool=function(){var a=this._getFilterItem();this._deleteFilterItems(),this._createBoolFilter(),this.query.filtered.filter.bool.must.push(a)},CB.CloudSearch.prototype._pushInMustFilter=function(a){this._makeFilteredQuery(),this.query.filtered.filter.bool&&this.query.filtered.filter.bool.must?this.query.filtered.filter.bool.must.push(a):this._getFilterItem()?(this._appendPrevFilterToBool(),this.query.filtered.filter.bool.must.push(a)):this.query.filtered.filter=a},CB.CloudSearch.prototype._pushInShouldFilter=function(a){this._makeFilteredQuery(),this.query.filtered.filter.bool&&this.query.filtered.filter.bool.should?this.query.filtered.filter.bool.should.push(a):this._getFilterItem()?(this._appendPrevFilterToBool(),this.query.filtered.filter.bool.should.push(a)):(this._createBoolFilter(),this.query.filtered.filter.bool.must_not.push(a))},CB.CloudSearch.prototype._pushInShouldQuery=function(a){this._makeFilteredQuery(),this.query.filtered.filter.bool&&this.query.filtered.filter.bool.should?this.query.filtered.filter.bool.should.push(a):this._getFilterItem()?(this._appendPrevFilterToBool(),this.query.filtered.filter.bool.should.push(a)):(this._createBoolFilter(),this.query.filtered.filter.bool.must_not.push(a))},CB.CloudSearch.prototype._pushInMustNotFilter=function(a){this._makeFilteredQuery(),this.query.filtered.filter.bool&&this.query.filtered.filter.bool.must_not?this.query.filtered.filter.bool.must_not.push(a):this._getFilterItem()?(this._appendPrevFilterToBool(),this.query.filtered.filter.bool.must_not.push(a)):(this._createBoolFilter(),this.query.filtered.filter.bool.must_not.push(a))},CB.CloudSearch.prototype.searchOn=function(a,b,c){return this._isFilteredQuery?a instanceof Array?(this.query.query.multi_match={},this.query.query.multi_match.query=b,this.query.query.multi_match.fields=a,c&&(this.query.query.multi_match.operator=c)):(this.query.query.match={},this.query.query.match[a]=b,c&&(this.query.query.match.operator=c)):a instanceof Array?(this.query.multi_match={},this.query.multi_match.query=b,this.query.multi_match.fields=a,c&&(this.query.multi_match.operator=c)):(this.query.match={},this.query.match[a]=b,c&&(this.query.match.operator=c)),this},CB.CloudSearch.prototype.search=function(a){CB._validate();var b,c=null;a||(b=new CB.Promise),c=this.collectionNames instanceof Array?this.collectionNames.join(","):this.collectionNames;var d=JSON.stringify({collectionName:c,query:this.query,sort:this.sort,limit:this.size,skip:this.from,key:CB.appKey});return url=CB.apiUrl+"/"+CB.appId+"/search",CB._request("POST",url,d).then(function(c){var d=CB._deserialize(JSON.parse(c));a?a.success(d):b.resolve(d)},function(c){a?a.error(c):b.reject(c)}),a?void 0:b},CB.CloudSearch.prototype.notEqualTo=function(a,b){("id"===a||"isSearchable"===a||"expires"===a)&&(a="_"+a);var c={};return b instanceof Array?(c.terms={},c.terms[a]=b):(c.term={},c.term[a]=b),this._pushInMustNotFilter(c),this},CB.CloudSearch.prototype.equalTo=function(a,b){("id"===a||"isSearchable"===a||"expires"===a)&&(a="_"+a);var c={};return b instanceof Array?(c.terms={},c.terms[a]=b):(c.term={},c.term[a]=b),this._pushInMustFilter(c),this},CB.CloudSearch.prototype.exists=function(a){("id"===a||"isSearchable"===a||"expires"===a)&&(a="_"+a);var b={};return b.exists={},b.exists.field=a,this._pushInMustFilter(b),this},CB.CloudSearch.prototype.doesNotExist=function(a){("id"===a||"isSearchable"===a||"expires"===a)&&(a="_"+a);var b={};return b.missing={},b.missing.field=a,this._pushInMustFilter(b),this},CB.CloudSearch.prototype.greaterThanOrEqual=function(a,b){("id"===a||"isSearchable"===a||"expires"===a)&&(a="_"+a);var c={};return c.range={},c.range[a]={},c.range[a].gte=b,this._pushInMustFilter(c),this},CB.CloudSearch.prototype.greaterThan=function(a,b){("id"===a||"isSearchable"===a||"expires"===a)&&(a="_"+a);var c={};return c.range={},c.range[a]={},c.range[a].gt=b,this._pushInMustFilter(c),this},CB.CloudSearch.prototype.lessThan=function(a,b){("id"===a||"isSearchable"===a||"expires"===a)&&(a="_"+a);var c={};return c.range={},c.range[a]={},c.range[a].lt=b,this._pushInMustFilter(c),this},CB.CloudSearch.prototype.lessthanOrEqual=function(a,b){("id"===a||"isSearchable"===a||"expires"===a)&&(a="_"+a);var c={};return c.range={},c.range[a]={},c.range[a].lte=b,this._pushInMustFilter(c),this},CB.CloudSearch.or=function(a,b){var c=[];if(a.collectionNames instanceof Array?c.append(a.collectionNames):c.push(a.collectionNames),b.collectionNames instanceof Array)for(var d=0;d<b.collectionNames;d++)c.indexOf(b.collectionNames[d])<0&&c.push(b.collectionNames[d]);else c.indexOf(b.collectionNames)<0&&c.push(b.collectionNames);var e=new CB.CloudSearch(c),f=null,g=null,h=null,i=null;return a.query.filtered&&a.query.filtered.query?f=a.query.filtered.query:a.query&&!a.query.filtered&&(f=a.query),b.query.filtered&&b.query.filtered.query?g=b.query.filtered.query:b.query&&!b.query.filtered&&(g=b.query),a.query.filtered&&a.query.filtered.filter&&(h=a.query.filtered.filter),b.query.filtered&&b.query.filtered.filter&&(i=b.query.filtered.filter),(h||i)&&(e._makeFilteredQuery(),h&&!i?e.query.filtered.filter=h:i&&!h?e.query.filtered.filter=i:(e._pushInShouldFilter(h),e._pushInShouldFilter(i))),e.query.filtered&&(Object.keys(f).length>0||Object.keys(g).length>0)&&(Object.keys(f).length>0&&!Object.keys(g).length>0?e.query.filtered.query=f:!Object.keys(f).length>0&&!Object.keys(g).length>0?e.query.filtered.query=g:(e.query.filtered.query.bool={should:[],must:[],must_not:[]},e.query.filtered.query.bool.should.push(f),e.query.filtered.query.bool.should.push(g))),e},CB.CloudUser=CB.CloudUser||function(){this.document||(this.document={}),this.document._tableName="User",this.document._type="user",this.document.ACL=new CB.ACL,this.document._isModified=!0,this.document._modifiedColumns=["createdAt","updatedAt","ACL"]},CB.CloudUser.prototype=Object.create(CB.CloudObject.prototype),Object.defineProperty(CB.CloudUser.prototype,"username",{get:function(){return this.document.username},set:function(a){this.document.username=a,CB._modified(this,"username")}}),Object.defineProperty(CB.CloudUser.prototype,"password",{get:function(){return this.document.password},set:function(a){this.document.password=a,CB._modified(this,"password")}}),Object.defineProperty(CB.CloudUser.prototype,"email",{get:function(){return this.document.email},set:function(a){this.document.email=a,CB._modified(this,"email")}}),CB.CloudUser.current=new CB.CloudUser,CB.CloudUser.prototype.signUp=function(a){if(!this.document.username)throw"Username is not set.";if(!this.document.password)throw"Password is not set.";if(!this.document.email)throw"Email is not set.";var b,c=this;a||(b=new CB.Promise);var d=JSON.stringify({document:CB._serialize(c),key:CB.appKey});return url=CB.apiUrl+"/"+CB.appId+"/user/signup",CB._request("POST",url,d).then(function(d){CB._deserialize(JSON.parse(d),c),CB.CloudUser.current=c,a?a.success(c):b.resolve(c)},function(c){a?a.error(c):b.reject(c)}),a?void 0:b},CB.CloudUser.prototype.logIn=function(a){if(!this.document.username)throw"Username is not set.";if(!this.document.password)throw"Password is not set.";var b,c=this;a||(b=new CB.Promise);var d=JSON.stringify({document:CB._serialize(c),key:CB.appKey});return url=CB.apiUrl+"/"+CB.appId+"/user/login",CB._request("POST",url,d).then(function(d){CB._deserialize(JSON.parse(d),c),CB.CloudUser.current=c,a?a.success(c):b.resolve(c)},function(c){a?a.error(c):b.reject(c)}),a?void 0:b},CB.CloudUser.prototype.logOut=function(a){if(!this.document.username)throw"Username is not set.";if(!this.document.password)throw"Password is not set.";var b,c=this;a||(b=new CB.Promise);var d=JSON.stringify({document:CB._serialize(c),key:CB.appKey});return url=CB.apiUrl+"/"+CB.appId+"/user/logout",CB._request("POST",url,d).then(function(d){CB._deserialize(JSON.parse(d),c),CB.CloudUser.current=null,a?a.success(c):b.resolve(c)},function(c){a?a.error(c):b.reject(c)}),a?void 0:b},CB.CloudUser.prototype.addToRole=function(a,b){if(!a)throw"Role is null";var c,d=this;b||(c=new CB.Promise);var e=JSON.stringify({user:CB._serialize(d),role:CB._serialize(a),key:CB.appKey});return url=CB.apiUrl+"/"+CB.appId+"/user/addToRole",CB._request("PUT",url,e).then(function(a){CB._deserialize(JSON.parse(a),d),b?b.success(d):c.resolve(d)},function(a){b?b.error(a):c.reject(a)}),b?void 0:c},CB.CloudUser.prototype.isInRole=function(a){if(!a)throw"role is null";return this.get("roles").indexOf(a.document._id)>=0},CB.CloudUser.prototype.removeFromRole=function(a,b){if(!a)throw"Role is null";var c,d=this;b||(c=new CB.Promise);var e=JSON.stringify({user:CB._serialize(d),role:CB._serialize(a),key:CB.appKey});return url=CB.apiUrl+"/"+CB.appId+"/user/removeFromRole",CB._request("PUT",url,e).then(function(a){CB._deserialize(JSON.parse(a),d),b?b.success(d):c.resolve(d)},function(a){b?b.error(a):c.reject(a)}),b?void 0:c},CB.CloudRole=CB.CloudRole||function(a){this.document||(this.document={}),this.document._tableName="Role",this.document._type="role",this.document.name=a,this.document.ACL=new CB.ACL,this.document._isModified=!0,this.document._modifiedColumns=["createdAt","updatedAt","ACL","name"]},CB.CloudRole.prototype=Object.create(CB.CloudObject.prototype),Object.defineProperty(CB.CloudRole.prototype,"name",{get:function(){return this.document.name},set:function(a){this.document.name=a,CB._modified(this,a)}}),CB.CloudRole.getRole=function(a,b){var c;b||(c=new CB.Promise);var d=a.document.name,e=JSON.stringify({key:CB.appKey});return url=CB.apiUrl+"/"+CB.appId+"/role/getRole/"+d,CB._request("POST",url,e).then(function(a){var d=CB._deserialize(JSON.parse(a));b?b.success(d):c.resolve(d);
},function(a){b?b.error(a):c.reject(a)}),b?void 0:c},CB.CloudFile=CB.CloudFile||function(a,b,c){if(!a)throw"File is null.";if("[object File]"===Object.prototype.toString.call(a)||"[object Blob]"===Object.prototype.toString.call(a))this.fileObj=a,this.document={_type:"file",name:a&&a.name&&""!==a.name?a.name:"unknown",size:a.size,url:"",contentType:"undefined"!=typeof a.type&&""!==a.type?a.type:"unknown"};else{if("string"!=typeof a)throw"Invalid File. It should be of type file or blob";var d=RegExp("https?://(?:www.|(?!www))[^s.]+.[^s]{2,}|www.[^s]+.[^s]{2,}");if(d.test(a))this.document={_type:"file",name:"",size:"",url:a,contentType:""};else{if(!b)throw"Invalid File. It should be of type file or blob";this.document={_type:"file",name:a,size:b}}}},Object.defineProperty(CB.CloudFile.prototype,"type",{get:function(){return this.document.contentType},set:function(a){this.document.contentType=a}}),Object.defineProperty(CB.CloudFile.prototype,"url",{get:function(){return this.document.url},set:function(a){this.document.url=a}}),Object.defineProperty(CB.CloudFile.prototype,"size",{get:function(){return this.document.size},set:function(a){this.document.size=a}}),Object.defineProperty(CB.CloudFile.prototype,"name",{get:function(){return this.document.name},set:function(a){this.document.name=a}}),CB.CloudFile.prototype.save=function(a){var b;a||(b=new CB.Promise);var c=this,d=new FormData;if(!this.fileObj)throw"You cannot save a file which is null";d.append("fileToUpload",this.fileObj),d.append("key",CB.appKey);var e=CB._loadXml(),f=d;if(url=CB.serverUrl+"/file/"+CB.appId+"/upload",e.open("POST",url,!0),CB._isNode){var g=require("node-localstorage").LocalStorage;localStorage=new g("./scratch"),e.setRequestHeader("User-Agent","CB/"+CB.version+" (NodeJS "+process.versions.node+")")}var h=localStorage.getItem("sessionID");return null!=h&&e.setRequestHeader("sessionID",h),e.send(f),e.onreadystatechange=function(){if(e.readyState==e.DONE)if(200==e.status){c.url=JSON.parse(e.responseText)._url;var d=e.getResponseHeader("sessionID");d?localStorage.setItem("sessionID",d):localStorage.removeItem("sessionID"),a?a.success(c):b.resolve(c)}else a?a.error(e.responseText):b.reject(e.responseText)},a?void 0:b},CB.CloudFile.prototype["delete"]=function(a){var b;if(!this.url)throw"You cannot delete a file which does not have an URL";a||(b=new CB.Promise);var c=this,d=JSON.stringify({url:c.url,key:CB.appKey});return url=CB.serverUrl+"/file/"+CB.appId+"/delete",CB._request("POST",url,d).then(function(d){c.url=null,a?a.success(c):b.resolve(c)},function(c){a?a.error(c):b.reject(c)}),a?void 0:b},CB.CloudGeoPoint=CB.CloudGeoPoint||function(a,b){if(!a||!b)throw"Latitude or Longitude is empty.";if(isNaN(a))throw"Latitude "+a+" is not a number type.";if(isNaN(b))throw"Longitude "+b+" is not a number type.";if(this.document={},this.document.type="Point",!(Number(a)>=-90&&Number(a)<=90&&Number(b)>=-180&&Number(b)<=180))throw"latitude and longitudes are not in range";this.document.coordinates=[Number(a),Number(b)]},Object.defineProperty(CB.CloudGeoPoint.prototype,"latitude",{get:function(){return this.document.coordinates[0]},set:function(a){if(!(Number(a)>=-90&&Number(a)<=90))throw"Latitude is not in Range";this.document.coordinates[0]=a}}),Object.defineProperty(CB.CloudGeoPoint.prototype,"longitude",{get:function(){return this.document.coordinates[1]},set:function(a){if(!(Number(a)>=-180&&Number(latitude)<=180))throw"Longitude is not in Range";this.document.coordinates[1]=a}}),CB.CloudGeoPoint.prototype.distanceInKMs=function(a){var b=6371;return b*greatCircleFormula(this,a)},CB.CloudGeoPoint.prototype.distanceInMiles=function(a){var b=3959;return b*greatCircleFormula(this,a)},CB.CloudGeoPoint.prototype.distanceInRadians=function(a){return greatCircleFormula(this,a)},"undefined"==typeof Number.prototype.toRad&&(Number.prototype.toRad=function(){return this*Math.PI/180}),CB._serialize=function(a){var b=null;a instanceof CB.CloudFile&&(b=a.document.url);var c=CB._clone(a,b);if(!c instanceof CB.CloudObject||!c instanceof CB.CloudFile||!c instanceof CB.CloudGeoPoint)throw"Data passed is not an instance of CloudObject or CloudFile or CloudGeoPoint";if(c instanceof CB.CloudFile)return c.document;if(c instanceof CB.CloudGeoPoint)return c.document;var d=c.document;for(var e in d)if(d[e]instanceof CB.CloudObject||d[e]instanceof CB.CloudFile||d[e]instanceof CB.CloudGeoPoint)d[e]=CB._serialize(d[e]);else if("ACL"===e){var f={write:d[e].write,read:d[e].read};d[e]=f}else if(d[e]instanceof Array&&d[e][0]&&(d[e][0]instanceof CB.CloudObject||d[e][0]instanceof CB.CloudFile||d[e][0]instanceof CB.CloudGeoPoint)){for(var g=[],h=0;h<d[e].length;h++)g.push(CB._serialize(d[e][h]));d[e]=g}return d},CB._deserialize=function(a,b){if(!a)return null;if(a instanceof Array){if(a[0]&&a[0]instanceof Object){for(var c=[],d=0;d<a.length;d++)h=CB._deserialize(a[d]),c.push(h);return c}return a}if(a instanceof Object&&a._type){var e={};for(var f in a)a[f]instanceof Array?e[f]=CB._deserialize(a[f]):a[f]instanceof Object?"ACL"===f?(e[f]=new CB.ACL,e[f].write=a[f].write,e[f].read=a[f].read):a[f]._type?b?e[f]=CB._deserialize(a[f],b.get(f)):e[f]=CB._deserialize(a[f]):a[f].latitude||a[f].longitude?e[f]=new CB.CloudGeoPoint(a[f].latitude,a[f].longitude):e[f]=a[f]:e[f]=a[f];if(b)return b.document=e,b;var g=null;"file"===e._type&&(g=e.url);var h=CB._getObjectByType(e._type,g);return h.document=e,h}return a},CB._getObjectByType=function(a,b){var c=null;return"custom"===a&&(c=new CB.CloudObject),"role"===a&&(c=new CB.CloudRole),"user"===a&&(c=new CB.CloudUser),"file"===a&&(c=new CB.CloudFile(b)),c},CB._validate=function(){if(!CB.appId)throw"AppID is null. Please use CB.CLoudApp.init to initialize your app.";if(!CB.appKey)throw"AppKey is null. Please use CB.CLoudApp.init to initialize your app."},function(){new Object}(),CB._isNode&&(module.exports={},module.exports=CB),CB._clone=function(a,b){var c=null;if(a.document._type){c=CB._getObjectByType(a.document._type,b);var d=a.document,e={};for(var f in d)d[f]instanceof CB.CloudObject?e[f]=CB._clone(d[f],null):d[f]instanceof CB.CloudFile?e[f]=CB._clone(d[f],d[f].document.url):d[f]instanceof CB.CloudGeoPoint?e[f]=CB._clone(d[f],null):e[f]=d[f]}else if(a instanceof CB.CloudGeoPoint){c=a;var d=a.document,e={};for(var f in d)e[f]=d[f]}return c.document=e,c},CB._request=function(a,b,c){var d=new CB.Promise,e=CB._loadXml();if(CB._isNode){var f=require("node-localstorage").LocalStorage;localStorage=new f("./scratch")}e.open(a,b,!0),e.setRequestHeader("Content-Type","text/plain");var g=localStorage.getItem("sessionID");return null!=g&&e.setRequestHeader("sessionID",g),CB._isNode&&e.setRequestHeader("User-Agent","CB/"+CB.version+" (NodeJS "+process.versions.node+")"),e.send(c),e.onreadystatechange=function(){if(e.readyState==e.DONE)if(200==e.status){var a=e.getResponseHeader("sessionID");a?localStorage.setItem("sessionID",a):localStorage.removeItem("sessionID"),d.resolve(e.responseText)}else console.log(e.status),d.reject(e.responseText)},d},CB._modified=function(a,b){a.document._isModified=!0,a.document._modifiedColumns?-1===a.document._modifiedColumns.indexOf(b)&&a.document._modifiedColumns.push(b):(a.document._modifiedColumns=[],a.document._modifiedColumns.push(b))};